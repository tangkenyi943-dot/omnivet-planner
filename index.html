<script>
    // ========== CONFIGURATION ==========
    const CORRECT_PASSWORD = "Omnivet0995";
    
    // üî¥ REPLACE THIS WITH YOUR ACTUAL GOOGLE SCRIPT URL:
    const API_URL = "https://script.google.com/macros/s/AKfycbzW_zqZFakfCGKsORWreDOEU8o_uXixoAb5mrgY6Uz_Eo6ylt-jDQIyG8i_rNAXEb76/exec";
    
    // ========== SIMPLE STATE ==========
    let bookingsData = {};
    let userColors = {};
    let currentDate = new Date();
    let selectedDate = null;
    
    // ========== MONTH NAMES ==========
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const dayNames = ["SUN","MON","TUE","WED","THU","FRI","SAT"];
    
    // ========== DOM ELEMENTS ==========
    const landingPage = document.getElementById('landingPage');
    const calendarPage = document.getElementById('calendarPage');
    const passwordModal = document.getElementById('passwordModal');
    const bookingModal = document.getElementById('bookingModal');
    const enterBtn = document.getElementById('enterBtn');
    const backBtn = document.getElementById('backBtn');
    const passwordInput = document.getElementById('passwordInput');
    const submitPassword = document.getElementById('submitPassword');
    const cancelPassword = document.getElementById('cancelPassword');
    const errorMessage = document.getElementById('errorMessage');
    const statusMessage = document.getElementById('statusMessage');
    const calendarEl = document.getElementById('calendar');
    const monthYearEl = document.getElementById('monthYear');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const bookingTitle = document.getElementById('bookingTitle');
    const existingBookingsEl = document.getElementById('existingBookings');
    const confirmBtn = document.getElementById('confirmBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const usernameInput = document.getElementById('username');
    const colorInput = document.getElementById('color');
    const colorPreview = document.getElementById('colorPreview');
    const startInput = document.getElementById('start');
    const endInput = document.getElementById('end');
    const descInput = document.getElementById('desc');
    
    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', function() {
        console.log("üöÄ OmniVet Planner Loaded");
        
        // Set initial color preview
        colorPreview.style.backgroundColor = colorInput.value;
        
        // Event Listeners
        enterBtn.addEventListener('click', showPasswordModal);
        backBtn.addEventListener('click', goBackToHome);
        submitPassword.addEventListener('click', checkPassword);
        cancelPassword.addEventListener('click', hidePasswordModal);
        prevBtn.addEventListener('click', showPreviousMonth);
        nextBtn.addEventListener('click', showNextMonth);
        confirmBtn.addEventListener('click', saveBooking);
        cancelBtn.addEventListener('click', hideBookingModal);
        colorInput.addEventListener('change', updateColorPreview);
        
        // Enter key for password
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkPassword();
        });
        
        // Test connection
        testConnection();
    });
    
    // ========== TEST CONNECTION ==========
    async function testConnection() {
        console.log("Testing Google Sheets connection...");
        try {
            const response = await fetch(API_URL + '?action=getBookings');
            const text = await response.text();
            console.log("‚úÖ API Response:", text.substring(0, 100));
        } catch (error) {
            console.error("‚ùå API Error:", error);
        }
    }
    
    // ========== PASSWORD FUNCTIONS ==========
    function showPasswordModal() {
        passwordModal.classList.add('active');
        passwordInput.value = '';
        errorMessage.style.display = 'none';
        passwordInput.focus();
    }
    
    function hidePasswordModal() {
        passwordModal.classList.remove('active');
    }
    
    async function checkPassword() {
        if (passwordInput.value === CORRECT_PASSWORD) {
            hidePasswordModal();
            showCalendar();
            await loadData();
        } else {
            errorMessage.style.display = 'block';
            passwordInput.value = '';
            passwordInput.focus();
        }
    }
    
    // ========== NAVIGATION ==========
    function goBackToHome() {
        calendarPage.classList.remove('active');
        landingPage.style.display = 'flex';
    }
    
    function showCalendar() {
        landingPage.style.display = 'none';
        calendarPage.classList.add('active');
    }
    
    function showPreviousMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    }
    
    function showNextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    }
    
    // ========== COLOR FUNCTIONS ==========
    function updateColorPreview() {
        colorPreview.style.backgroundColor = colorInput.value;
    }
    
    // ========== LOAD DATA ==========
    async function loadData() {
        try {
            showStatus('Loading data...', 'info');
            
            // Load bookings
            const response = await fetch(API_URL + '?action=getBookings');
            const data = await response.json();
            
            // Check if data is valid
            if (data && typeof data === 'object') {
                bookingsData = data;
                console.log('‚úÖ Loaded', Object.keys(bookingsData).length, 'booking dates');
            } else {
                bookingsData = {};
                console.log('‚úÖ No bookings yet');
            }
            
            // Load user colors
            const colorsResponse = await fetch(API_URL + '?action=getUserColors');
            const colorsData = await colorsResponse.json();
            
            if (colorsData && typeof colorsData === 'object') {
                userColors = colorsData;
            } else {
                userColors = {};
            }
            
            showStatus('Data loaded!', 'success');
            setTimeout(() => hideStatus(), 2000);
            
            renderCalendar();
            
        } catch (error) {
            console.error('‚ùå Error loading:', error);
            showStatus('‚ö†Ô∏è Cannot connect to server', 'error');
            bookingsData = {};
            userColors = {};
            renderCalendar();
        }
    }
    
    // ========== SAVE BOOKING ==========
    async function saveBooking() {
        if (!selectedDate) return;
        
        const name = usernameInput.value.trim();
        const color = colorInput.value;
        const start = formatTime(startInput.value);
        const end = formatTime(endInput.value);
        const desc = descInput.value.trim();
        
        // Validation
        if (!name) {
            showStatus('Please enter your name', 'error');
            return;
        }
        
        if (!start || !end) {
            showStatus('Please enter start and end times', 'error');
            return;
        }
        
        showStatus('Saving to Google Sheets...', 'info');
        
        try {
            // Prepare data
            const params = new URLSearchParams();
            params.append('action', 'addBooking');
            params.append('date', selectedDate);
            params.append('name', name);
            params.append('color', color);
            params.append('start', start);
            params.append('end', end);
            params.append('desc', desc);
            
            // Send to Google Script
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: params
            });
            
            const result = await response.json();
            console.log('Save result:', result);
            
            if (result && result.success) {
                // Update local data
                userColors[name] = color;
                
                if (!bookingsData[selectedDate]) {
                    bookingsData[selectedDate] = [];
                }
                
                bookingsData[selectedDate].push({
                    name: name,
                    color: color,
                    start: start,
                    end: end,
                    desc: desc
                });
                
                showStatus('‚úÖ Booking saved successfully!', 'success');
                setTimeout(() => hideStatus(), 2000);
                
                hideBookingModal();
                renderCalendar();
                
            } else {
                showStatus('‚ùå Failed to save: ' + (result?.error || 'Unknown error'), 'error');
            }
            
        } catch (error) {
            console.error('‚ùå Save error:', error);
            showStatus('‚ùå Network error. Please try again.', 'error');
        }
    }
    
    // ========== DELETE BOOKING ==========
    async function deleteBookingFromAPI(date, name, start) {
        try {
            const params = new URLSearchParams();
            params.append('action', 'deleteBooking');
            params.append('date', date);
            params.append('name', name);
            params.append('start', start);
            
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: params
            });
            
            const result = await response.json();
            return result && result.success;
            
        } catch (error) {
            console.error('Delete error:', error);
            return false;
        }
    }
    
    // ========== FORMAT TIME ==========
    function formatTime(input) {
        input = input.trim().toLowerCase();
        if (!input) return '';
        
        // Handle special cases
        if (input === 'noon') return '12:00';
        if (input === 'midnight') return '00:00';
        
        // Try to parse
        const match = input.match(/^(\d{1,2})(?::(\d{2}))?\s*(am|pm)?$/);
        if (match) {
            let hours = parseInt(match[1]);
            const minutes = match[2] ? parseInt(match[2]) : 0;
            const period = match[3];
            
            // Convert to 24-hour
            if (period === 'pm' && hours < 12) hours += 12;
            if (period === 'am' && hours === 12) hours = 0;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }
        
        return input;
    }
    
    function formatDisplayTime(timeStr) {
        if (!timeStr) return '';
        if (timeStr.includes('am') || timeStr.includes('pm')) return timeStr;
        
        const [hours, minutes] = timeStr.split(':').map(Number);
        const period = hours >= 12 ? 'pm' : 'am';
        const hours12 = hours % 12 || 12;
        return `${hours12}:${minutes.toString().padStart(2, '0')}${period}`;
    }
    
    // ========== CALENDAR FUNCTIONS ==========
    function renderCalendar() {
        calendarEl.innerHTML = '';
        
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        monthYearEl.textContent = `${monthNames[month]} ${year}`;
        
        // Add day headers
        dayNames.forEach(day => {
            const dayEl = document.createElement('div');
            dayEl.className = 'day-header';
            dayEl.textContent = day;
            calendarEl.appendChild(dayEl);
        });
        
        // Get first day of month
        const firstDay = new Date(year, month, 1).getDay();
        
        // Add empty cells
        for (let i = 0; i < firstDay; i++) {
            const empty = document.createElement('div');
            empty.className = 'day empty';
            calendarEl.appendChild(empty);
        }
        
        // Get days in month
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        // Create day cells
        for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'day';
            dayEl.textContent = day;
            
            // Format date key
            const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            // Check for bookings
            if (bookingsData[dateKey] && bookingsData[dateKey].length > 0) {
                dayEl.classList.add('has-booking');
                
                // Add color dots
                const dots = document.createElement('div');
                dots.className = 'booking-dots';
                
                bookingsData[dateKey].forEach(booking => {
                    const dot = document.createElement('div');
                    dot.className = 'booking-dot';
                    dot.style.backgroundColor = booking.color;
                    dots.appendChild(dot);
                });
                
                dayEl.appendChild(dots);
                
                // Add click event
                dayEl.addEventListener('click', () => showBookingsForDate(dateKey));
            } else {
                dayEl.addEventListener('click', () => showBookingsForDate(dateKey));
            }
            
            calendarEl.appendChild(dayEl);
        }
    }
    
    // ========== SHOW BOOKINGS FOR DATE ==========
    async function showBookingsForDate(date) {
        selectedDate = date;
        
        // Format date for display
        const [year, month, day] = date.split('-');
        const dateObj = new Date(year, month - 1, day);
        const formattedDate = `${monthNames[dateObj.getMonth()]} ${day}, ${year}`;
        
        bookingTitle.textContent = `Bookings for ${formattedDate}`;
        
        // Load fresh data
        await loadData();
        
        const dateBookings = bookingsData[date] || [];
        
        // Show existing bookings
        if (dateBookings.length > 0) {
            existingBookingsEl.innerHTML = `
                <h4>Existing Bookings (${dateBookings.length})</h4>
                ${dateBookings.map((booking, index) => `
                    <div class="booking-item" style="border-left-color: ${booking.color}">
                        <div class="booking-info">
                            <h4>${booking.name}</h4>
                            <p>${formatDisplayTime(booking.start)} - ${formatDisplayTime(booking.end)}</p>
                            ${booking.desc ? `<p><small>${booking.desc}</small></p>` : ''}
                        </div>
                        <button class="delete-btn" onclick="handleDeleteBooking('${date}', '${booking.name}', '${booking.start}', ${index})">Delete</button>
                    </div>
                `).join('')}
            `;
        } else {
            existingBookingsEl.innerHTML = '<p>No bookings for this date yet.</p>';
        }
        
        // Reset form
        usernameInput.value = '';
        colorInput.value = '#FF6B6B';
        updateColorPreview();
        startInput.value = '';
        endInput.value = '';
        descInput.value = '';
        
        // Show modal
        bookingModal.classList.add('active');
    }
    
    // Global delete function
    window.handleDeleteBooking = async function(date, name, startTime, index) {
        if (confirm(`Delete booking for ${name}?`)) {
            try {
                const success = await deleteBookingFromAPI(date, name, startTime);
                
                if (success) {
                    // Remove from local data
                    if (bookingsData[date]) {
                        bookingsData[date].splice(index, 1);
                        if (bookingsData[date].length === 0) {
                            delete bookingsData[date];
                        }
                    }
                    
                    showStatus('‚úÖ Booking deleted!', 'success');
                    setTimeout(() => hideStatus(), 2000);
                    
                    // Refresh
                    showBookingsForDate(date);
                    renderCalendar();
                } else {
                    showStatus('‚ùå Failed to delete', 'error');
                }
                
            } catch (error) {
                showStatus('‚ùå Error deleting', 'error');
            }
        }
    };
    
    function hideBookingModal() {
        bookingModal.classList.remove('active');
        selectedDate = null;
    }
    
    // ========== STATUS MESSAGES ==========
    function showStatus(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = 'status-message';
        statusMessage.classList.add(`status-${type}`);
        statusMessage.style.display = 'block';
    }
    
    function hideStatus() {
        statusMessage.style.display = 'none';
    }
</script>
